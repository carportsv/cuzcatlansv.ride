<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Fix Notifications - Diagn√≥stico y Correcci√≥n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .step h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Notifications - Diagn√≥stico y Correcci√≥n</h1>
        
        <div class="section">
            <h2>üìã Problema Identificado</h2>
            <p>El error <code>"Could not find the 'body' column of 'notifications' in the schema cache"</code> indica que la tabla <code>notifications</code> en Supabase no tiene la estructura correcta.</p>
        </div>

        <div class="section">
            <h2>üîç Paso 1: Diagn√≥stico</h2>
            <p>Verifica el estado actual de la tabla notifications:</p>
            <button class="button" onclick="runDiagnostic()">üîç Ejecutar Diagn√≥stico</button>
            <div id="diagnostic-log" class="log" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è Paso 2: Correcci√≥n SQL</h2>
            <p>Ejecuta este script en <strong>Supabase Dashboard ‚Üí SQL Editor</strong>:</p>
            <div class="step">
                <h3>Script de Correcci√≥n:</h3>
                <textarea id="sql-script" readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
-- Script para corregir la tabla notifications
-- Ejecutar en Supabase Dashboard > SQL Editor

-- 1. Crear tabla si no existe
CREATE TABLE IF NOT EXISTS notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
    ride_id UUID REFERENCES ride_requests(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    body TEXT NOT NULL,
    data JSONB DEFAULT '{}',
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    read_at TIMESTAMP WITH TIME ZONE
);

-- 2. Agregar columna body si no existe
ALTER TABLE notifications 
ADD COLUMN IF NOT EXISTS body TEXT;

-- 3. Hacer la columna body NOT NULL
ALTER TABLE notifications 
ALTER COLUMN body SET NOT NULL;

-- 4. Crear √≠ndices
CREATE INDEX IF NOT EXISTS idx_notifications_driver_id ON notifications(driver_id);
CREATE INDEX IF NOT EXISTS idx_notifications_ride_id ON notifications(ride_id);
CREATE INDEX IF NOT EXISTS idx_notifications_created_at ON notifications(created_at);
CREATE INDEX IF NOT EXISTS idx_notifications_unread ON notifications(driver_id, is_read) WHERE is_read = FALSE;

-- 5. Configurar RLS
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

-- 6. Crear pol√≠ticas RLS
DROP POLICY IF EXISTS "Drivers can view own notifications" ON notifications;
CREATE POLICY "Drivers can view own notifications" ON notifications
    FOR SELECT USING (
        driver_id IN (
            SELECT id FROM drivers WHERE user_id = auth.uid()
        )
    );

DROP POLICY IF EXISTS "Admins can create notifications" ON notifications;
CREATE POLICY "Admins can create notifications" ON notifications
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin'
        )
    );

DROP POLICY IF EXISTS "Drivers can update own notifications" ON notifications;
CREATE POLICY "Drivers can update own notifications" ON notifications
    FOR UPDATE USING (
        driver_id IN (
            SELECT id FROM drivers WHERE user_id = auth.uid()
        )
    );

-- 7. Dar permisos
GRANT ALL ON notifications TO authenticated;
GRANT ALL ON notifications TO anon;
GRANT ALL ON notifications TO service_role;
                </textarea>
                <button class="button" onclick="copyToClipboard()">üìã Copiar Script</button>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Paso 3: Prueba</h2>
            <p>Despu√©s de ejecutar el script SQL, prueba la funcionalidad:</p>
            <button class="button" onclick="testNotification()">üß™ Probar Notificaci√≥n</button>
            <div id="test-log" class="log" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>‚úÖ Paso 4: Verificaci√≥n Final</h2>
            <p>Verifica que el problema se haya solucionado:</p>
            <button class="button" onclick="finalVerification()">‚úÖ Verificaci√≥n Final</button>
            <div id="final-log" class="log" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase desde variables de entorno
        let SUPABASE_URL = '';
        let SUPABASE_KEY = '';
        
        // Obtener configuraci√≥n desde CONFIG (que carga desde .env)
        if (typeof CONFIG !== 'undefined') {
            SUPABASE_URL = CONFIG.SUPABASE_URL;
            SUPABASE_KEY = CONFIG.SUPABASE_ANON_KEY;
        } else {
            console.error('‚ùå CONFIG no est√° disponible. Aseg√∫rate de que config.js est√© cargado.');
            alert('Error: No se puede acceder a la configuraci√≥n. Aseg√∫rate de que config.js est√© cargado.');
            return;
        }

        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            logElement.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function runDiagnostic() {
            clearLog('diagnostic-log');
            log('diagnostic-log', 'üîç Iniciando diagn√≥stico de la tabla notifications...', 'info');
            
            try {
                // Verificar si la tabla existe
                log('diagnostic-log', 'üìã Verificando existencia de la tabla...', 'info');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/notifications?select=*&limit=0`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    log('diagnostic-log', '‚úÖ Tabla notifications existe y es accesible', 'success');
                    
                    // Verificar estructura
                    const structureResponse = await fetch(`${SUPABASE_URL}/rest/v1/notifications?select=id,driver_id,ride_id,title,body,data,is_read,created_at&limit=1`, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (structureResponse.ok) {
                        log('diagnostic-log', '‚úÖ Estructura de tabla verificada - columna body existe', 'success');
                    } else {
                        log('diagnostic-log', '‚ùå Error al verificar estructura: ' + structureResponse.status, 'error');
                        const errorText = await structureResponse.text();
                        log('diagnostic-log', 'Error details: ' + errorText, 'error');
                    }
                } else {
                    log('diagnostic-log', '‚ùå Error al acceder a la tabla: ' + response.status, 'error');
                    const errorText = await response.text();
                    log('diagnostic-log', 'Error details: ' + errorText, 'error');
                }

            } catch (error) {
                log('diagnostic-log', '‚ùå Error en diagn√≥stico: ' + error.message, 'error');
            }
        }

        async function testNotification() {
            clearLog('test-log');
            log('test-log', 'üß™ Iniciando prueba de notificaci√≥n...', 'info');
            
            try {
                // Obtener datos de prueba
                const driversResponse = await fetch(`${SUPABASE_URL}/rest/v1/drivers?select=id&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                const ridesResponse = await fetch(`${SUPABASE_URL}/rest/v1/ride_requests?select=id&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!driversResponse.ok || !ridesResponse.ok) {
                    log('test-log', '‚ùå No se pudieron obtener datos de prueba', 'error');
                    return;
                }

                const drivers = await driversResponse.json();
                const rides = await ridesResponse.json();

                if (drivers.length === 0 || rides.length === 0) {
                    log('test-log', '‚ùå No hay drivers o rides disponibles para la prueba', 'error');
                    return;
                }

                const testNotification = {
                    driver_id: drivers[0].id,
                    ride_id: rides[0].id,
                    title: 'üß™ Prueba de Notificaci√≥n',
                    body: 'Esta es una notificaci√≥n de prueba generada desde el navegador.',
                    data: { test: true, timestamp: new Date().toISOString() }
                };

                log('test-log', 'üìù Insertando notificaci√≥n de prueba...', 'info');
                const insertResponse = await fetch(`${SUPABASE_URL}/rest/v1/notifications`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testNotification)
                });

                if (insertResponse.ok) {
                    const result = await insertResponse.json();
                    log('test-log', '‚úÖ Notificaci√≥n insertada exitosamente: ' + result[0].id, 'success');
                    
                    // Limpiar notificaci√≥n de prueba
                    setTimeout(async () => {
                        const deleteResponse = await fetch(`${SUPABASE_URL}/rest/v1/notifications?id=eq.${result[0].id}`, {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        });

                        if (deleteResponse.ok) {
                            log('test-log', 'üßπ Notificaci√≥n de prueba eliminada', 'success');
                        } else {
                            log('test-log', '‚ö†Ô∏è No se pudo eliminar la notificaci√≥n de prueba', 'warning');
                        }
                    }, 2000);
                } else {
                    const errorText = await insertResponse.text();
                    log('test-log', '‚ùå Error al insertar notificaci√≥n: ' + insertResponse.status, 'error');
                    log('test-log', 'Error details: ' + errorText, 'error');
                }

            } catch (error) {
                log('test-log', '‚ùå Error en prueba: ' + error.message, 'error');
            }
        }

        async function finalVerification() {
            clearLog('final-log');
            log('final-log', '‚úÖ Iniciando verificaci√≥n final...', 'info');
            
            try {
                // Verificar que la tabla funciona correctamente
                const response = await fetch(`${SUPABASE_URL}/rest/v1/notifications?select=id,title,body,created_at&limit=5`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('final-log', '‚úÖ Tabla notifications funciona correctamente', 'success');
                    log('final-log', `üìä Total de notificaciones: ${data.length}`, 'info');
                    
                    if (data.length > 0) {
                        log('final-log', 'üìù √öltimas notificaciones:', 'info');
                        data.forEach(notification => {
                            log('final-log', `  - ${notification.title}: ${notification.body.substring(0, 50)}...`, 'info');
                        });
                    }
                } else {
                    log('final-log', '‚ùå Error en verificaci√≥n final: ' + response.status, 'error');
                }

            } catch (error) {
                log('final-log', '‚ùå Error en verificaci√≥n: ' + error.message, 'error');
            }
        }

        function copyToClipboard() {
            const textarea = document.getElementById('sql-script');
            textarea.select();
            document.execCommand('copy');
            alert('‚úÖ Script copiado al portapapeles. P√©galo en Supabase Dashboard ‚Üí SQL Editor');
        }
    </script>
</body>
</html>
