<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Create Ride | TaxiApp</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="create-ride.css">
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
    <!-- Leaflet CSS para el mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Control Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-content">
                <button class="back-btn" onclick="goBack()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <h1>Create Ride</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openCreateRideModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <defs>
                                <linearGradient id="createGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="url(#createGradient)"/>
                        </svg>
                        Create Ride
                    </button>
                    <button class="refresh-btn" onclick="loadData()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M1 4V10H7M23 20V14H17M20.49 9A9 9 0 0 0 5.64 5.64L1 10M1 14L5.64 18.36A9 9 0 0 0 20.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Loading -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Loading data...</p>
        </div>

        <!-- Main Content -->
        <main class="admin-main" id="mainContent" style="display: none;">
            <!-- Create Ride Instructions -->
            <section class="admin-section">
                <div class="section-header">
                    <h2>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="#ffffff"/>
                        </svg>
                        Create New Ride
                    </h2>
                </div>
                <div class="section-description">
                    <p>Click the "Create Ride" button in the header to open the ride creation form</p>
                </div>
                <div class="create-ride-info">
                    <div class="info-card">
                        <div class="info-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="#4ecdc4"/>
                            </svg>
                        </div>
                        <div class="info-content">
                            <h3>Quick Ride Creation</h3>
                            <p>Use the modal form to quickly create new ride requests with origin, destination, pricing, and driver assignment options.</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" fill="#ffd93d"/>
                            </svg>
                        </div>
                        <div class="info-content">
                            <h3>Map Integration</h3>
                            <p>Select addresses from the interactive map or enter them manually. Calculate routes and distances automatically.</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" fill="#ff6b6b"/>
                            </svg>
                        </div>
                        <div class="info-content">
                            <h3>Driver Assignment</h3>
                            <p>Assign rides to specific drivers or leave them unassigned to appear in the pending rides section.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Create Ride Modal -->
        <div id="createRideModal" class="modal-overlay" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>New Ride</h3>
                    <button class="modal-close" onclick="closeCreateRideModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="create-ride-container">
                        <!-- Formulario -->
                        <div class="form-section">
                            <form id="createRideForm">
                                <div class="form-group">
                                    <label for="rideOrigin">Origin *</label>
                                    <div class="input-with-actions">
                                        <input type="text" id="rideOrigin" name="origin" required placeholder="Search origin address..." readonly>
                                        <div class="input-actions">
                                            <button type="button" class="btn btn-sm btn-outline" onclick="enableOriginInput()">
                                                ‚úèÔ∏è Write
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline" onclick="selectOriginFromMap()">
                                                üó∫Ô∏è Take from map
                                            </button>
                                        </div>
                                    </div>
                                    <div class="input-icon">üìç</div>
                                </div>
                                <div class="form-group">
                                    <label for="rideDestination">Destination *</label>
                                    <div class="input-with-actions">
                                        <input type="text" id="rideDestination" name="destination" required placeholder="Search destination address..." readonly>
                                        <div class="input-actions">
                                            <button type="button" class="btn btn-sm btn-outline" onclick="enableDestinationInput()">
                                                ‚úèÔ∏è Write
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline" onclick="selectDestinationFromMap()">
                                                üó∫Ô∏è Take from map
                                            </button>
                                        </div>
                                    </div>
                                    <div class="input-icon">üéØ</div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="ridePrice">Price ($) *</label>
                                        <div class="input-with-actions">
                                            <input type="number" id="ridePrice" name="price" required min="1" step="0.01" placeholder="0.00">
                                            <div class="input-actions">
                                                <button type="button" class="btn btn-sm btn-outline" onclick="calculatePrice()">
                                                    üí∞ Calculate Price
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline" onclick="calculateRoute()">
                                                    üó∫Ô∏è Calculate Route
                                                </button>
                                            </div>
                                        </div>
                                        <div class="price-display" id="priceDisplay" style="display: none;">
                                            <span class="price-label">Estimated Price:</span>
                                            <span class="price-value">$0.00</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="rideDistance">Distance (km)</label>
                                        <input type="number" id="rideDistance" name="distance" min="0" step="0.1" placeholder="0.0" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="rideClientName">Client Name *</label>
                                    <input type="text" id="rideClientName" name="client_name" required placeholder="Name of the client requesting the ride">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="rideScheduledDate">Ride Date</label>
                                        <input type="date" id="rideScheduledDate" name="scheduled_date" min="">
                                    </div>
                                    <div class="form-group">
                                        <label for="rideScheduledTime">Ride Time</label>
                                        <input type="time" id="rideScheduledTime" name="scheduled_time">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="ridePriority">Priority</label>
                                    <select id="ridePriority" name="priority">
                                        <option value="normal">Normal</option>
                                        <option value="low">Low</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="rideAdditionalNotes">Additional Notes</label>
                                    <textarea id="rideAdditionalNotes" name="additional_notes" rows="3" placeholder="Additional ride information..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="rideUser">Driver (Optional)</label>
                                    <select id="rideUser" name="driver_id">
                                        <option value="">Unassigned (remains pending)</option>
                                    </select>
                                    <small class="form-help">Leave unassigned to schedule the ride for a future date</small>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Mapa -->
                        <div class="map-section">
                            <div class="map-header">
                                <h4>Route View</h4>
                                <div class="map-controls">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="getCurrentLocation()">
                                        üìç My Location
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="calculateRoute()">
                                        üó∫Ô∏è Calculate Route
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="clearAllMarkers()">
                                        üóëÔ∏è Clear Markers
                                    </button>
                                </div>
                            </div>
                            <div class="map-instructions">
                                <small>
                                    üí° <strong>Map Instructions:</strong><br>
                                    ‚Ä¢ <strong>Use the buttons</strong> "Write" or "Take from map" for each field<br>
                                    ‚Ä¢ <strong>Click on the map</strong> to select the corresponding address<br>
                                    ‚Ä¢ <strong>Click anywhere on the map</strong> to add a marker and see exact coordinates<br>
                                    ‚Ä¢ <strong>Use "Clear Markers"</strong> to remove all custom markers<br>
                                    ‚Ä¢ <strong>Inputs are locked</strong> until you choose how to enter the address
                                </small>
                            </div>
                            <div id="routeMap" class="route-map"></div>
                            <div class="route-info" id="routeInfo" style="display: none;">
                                <div class="route-summary">
                                    <span class="route-distance" id="routeDistance">0 km</span>
                                    <span class="route-duration" id="routeDuration">0 min</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCreateRideModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="createRide()">Create Ride</button>
                </div>
            </div>
        </div>

        <!-- Driver Selection Modal -->
        <div id="driverSelectionModal" class="modal-overlay" style="display: none;">
            <div class="modal-content glassmorphism-modal">
                <div class="modal-header">
                    <h3>Select Driver</h3>
                    <button class="modal-close" onclick="closeDriverSelectionModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="driverSelectionList" class="driver-selection-list">
                        <!-- Driver list will be generated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeDriverSelectionModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="confirmTitle">Confirm Action</h3>
                    <button class="modal-close" onclick="closeConfirmModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">Are you sure you want to perform this action?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                    <button class="btn btn-primary" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications" class="notifications"></div>
    </div>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    
    <script src="../../js/config.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/shared-utils.js"></script>
    <script src="../../js/maps.js"></script>
    <script src="../../js/admin.js"></script>
    <script src="create-ride.js"></script>
</body>
</html>
